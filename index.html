<!DOCTYPE html>
<html lang="en">

<head>
    <title>AgroSmart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Roboto, sans-serif;
            background-color: rgb(253, 253, 249);
        }

        .biggest-box {
            text-align: center;
        }

        .big-box {
            width: 237.6px;
            height: 360px;
            background-color: rgb(242, 245, 216);
            border-radius: 12px;
            padding: 10px;
            margin: 40px 20px;
            display: inline-block;
            vertical-align: top;
        }

        .title-soil {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            margin-bottom: 10px;
            margin-left: 20px;
        }

        .soil-moisture {
            color: rgb(81, 81, 14);
            font-size: 20px;
            font-weight: bold;
            margin-left: 7px;
        }

        .soil-img {
            width: 40px;
            height: 40px;
            margin-right: 30px;
        }

        .little-box {
            background-color: rgb(255, 255, 230);
            width: 100%;
            height: 190px;
            border-radius: 8px;
            margin-top: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .sensor-value {
            font-size: 24px;
            font-weight: bold;
            color: rgb(81, 81, 14);
        }

        #connectBleButton,
        #disconnectBleButton,
        #onButton,
        #offButton {
            display: inline-block;
            margin: 10px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 30px;
            border: 2px solid rgb(81, 81, 14);
            color: rgb(81, 81, 14);
            background-color: rgb(254, 254, 248);
            font-weight: 600;
            cursor: pointer;
        }

        #bleState {
            font-weight: bold;
            margin-top: 15px;
            display: block;
        }

        #valueSent {
            color: rgb(81, 81, 14);
            font-weight: bold;
        }

        .crop-box {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid rgb(81, 81, 14);
            border-radius: 10px;
            display: inline-block;
            background-color: rgb(254, 254, 248);
        }

        #cropSelect {
            border-radius: 4px;
            border-style: solid;
            border-color: rgb(81, 81, 14);
            color: rgb(81, 81, 14);
            border-width: 1px;
        }
    </style>
</head>

<body>
    <!-- Crop Selection -->
    <div style="text-align:center;">
        <div class="crop-box">
            <h3>Select Crop</h3>
            <select id="cropSelect">
                <option value="">Choose a crop</option>
                <option value="Rice">Rice</option>
                <option value="Maize">Maize</option>
                <option value="Wheat">Wheat</option>
                <option value="Mustard">Mustard</option>
                <option value="Large Cardamom">Large Cardamom</option>
            </select>
            <p id="cropInfo"></p>
        </div>
    </div>

    <!-- Sensor Data Boxes -->
    <div class="biggest-box">
        <div class="big-box">
            <div class="title-soil">
                <p class="soil-moisture">Soil Moisture(v/v%)</p>
                <img class="soil-img" src="https://i.postimg.cc/jdvkN7gh/soilmoisture.png">
            </div>
            <div class="little-box">
                <span class="sensor-value" id="soilValueContainer">NaN</span>
            </div>
            <p>Last Soil reading: <span id="soilTimestamp"></span></p>
        </div>

        <div class="big-box">
            <div class="title-soil">
                <p class="soil-moisture">Temperature(&#8451)</p>
                <img class="soil-img" src="https://i.postimg.cc/wjv4kjnY/temperature.png">
            </div>
            <div class="little-box">
                <span class="sensor-value" id="dhtValueContainer">NaN</span>
            </div>
            <p>Last DHT11 reading: <span id="dhtTimestamp"></span></p>
        </div>

        <div class="big-box">
            <div class="title-soil">
                <p class="soil-moisture">Water Level(%)</p>
                <img class="soil-img" src="https://i.postimg.cc/85NgFqNs/water-level.png">
            </div>
            <div class="little-box">
                <span class="sensor-value" id="waterValueContainer">NaN</span>
            </div>
            <p>Last Water level reading: <span id="waterTimestamp"></span></p>
        </div>
    </div>

    
    <div style="text-align:center;">
        <button id="connectBleButton">Connect to BLE Device</button>
        <button id="disconnectBleButton">Disconnect BLE Device</button>
        <p>BLE state: <strong><span id="bleState" style="color:rgb(209,58,48);">Disconnected</span></strong></p>

        <h2>Control GPIO 2</h2>
        <button id="onButton">ON</button>
        <button id="offButton">OFF</button>
        <p>Last value sent: <span id="valueSent"></span></p>
    </div>

    <script>
        // DOM Elements
        const connectButton = document.getElementById('connectBleButton');
        const disconnectButton = document.getElementById('disconnectBleButton');
        const onButton = document.getElementById('onButton');
        const offButton = document.getElementById('offButton');
        const dhtValueContainer = document.getElementById('dhtValueContainer');
        const soilValueContainer = document.getElementById('soilValueContainer');
        const waterValueContainer = document.getElementById('waterValueContainer');
        const latestValueSent = document.getElementById('valueSent');
        const bleStateContainer = document.getElementById('bleState');
        const dhtTimestampContainer = document.getElementById('dhtTimestamp');
        const soilTimestampContainer = document.getElementById('soilTimestamp');
        const waterTimestampContainer = document.getElementById('waterTimestamp');

        // BLE Device Specs
        var deviceName = 'ESP32';
        var bleService = '796a9ae0-3d3b-4df9-9f5e-b2c9518d1401';
        var ledCharacteristic = 'be27038d-b3ef-44cd-a643-9947c9bab495';
        var dhtCharacteristic = '3cc918a8-ff40-455a-99cc-ec8a9f5581e6';
        var soilCharacteristic = '378715fe-038b-41c2-b27b-20d6083d6908';
        var waterCharacteristic = '2af6c2df-bc1d-4505-bf11-01e74b0761c6';

        // BLE Globals
        var bleServer;
        var bleServiceFound;
        var dhtCharacteristicFound;
        var soilCharacteristicFound;
        var waterCharacteristicFound;

        connectButton.addEventListener('click', () => {
            if (isWebBluetoothEnabled()) connectToDevice();
        });

        disconnectButton.addEventListener('click', disconnectDevice);
        onButton.addEventListener('click', () => writeOnCharacteristic(1));
        offButton.addEventListener('click', () => writeOnCharacteristic(0));

        function isWebBluetoothEnabled() {
            if (!navigator.bluetooth) {
                bleStateContainer.innerHTML = "Web Bluetooth API is not available in this browser!";
                return false;
            }
            return true;
        }

        function connectToDevice() {
            navigator.bluetooth.requestDevice({
                filters: [{ name: deviceName }],
                optionalServices: [bleService]
            })
                .then(device => {
                    bleStateContainer.innerHTML = 'Connected to device ' + device.name;
                    bleStateContainer.style.color = "rgb(36,175,55)";
                    device.addEventListener('gattservicedisconnected', onDisconnected);
                    return device.gatt.connect();
                })
                .then(gattServer => {
                    bleServer = gattServer;
                    return bleServer.getPrimaryService(bleService);
                })
                .then(service => {
                    bleServiceFound = service;
                    return Promise.all([
                        service.getCharacteristic(dhtCharacteristic),
                        service.getCharacteristic(soilCharacteristic),
                        service.getCharacteristic(waterCharacteristic)
                    ]);
                })
                .then(characteristics => {
                    dhtCharacteristicFound = characteristics[0];
                    soilCharacteristicFound = characteristics[1];
                    waterCharacteristicFound = characteristics[2];

                    dhtCharacteristicFound.addEventListener('characteristicvaluechanged', handleDHTCharacteristicChange);
                    dhtCharacteristicFound.startNotifications();

                    soilCharacteristicFound.addEventListener('characteristicvaluechanged', handleSoilCharacteristicChange);
                    soilCharacteristicFound.startNotifications();

                    waterCharacteristicFound.addEventListener('characteristicvaluechanged', handleWaterCharacteristicChange);
                    waterCharacteristicFound.startNotifications();
                })
                .catch(error => {
                    console.log('Error:', error);
                });
        }

        function onDisconnected(event) {
            bleStateContainer.innerHTML = "Device disconnected";
            bleStateContainer.style.color = "rgb(209,58,48)";
        }

        function handleDHTCharacteristicChange(event) {
            const newValue = new TextDecoder().decode(event.target.value);
            dhtValueContainer.innerHTML = newValue;
            dhtTimestampContainer.innerHTML = getDateTime();
        }

        function handleSoilCharacteristicChange(event) {
            const newValue = new TextDecoder().decode(event.target.value);
            soilValueContainer.innerHTML = newValue;
            soilTimestampContainer.innerHTML = getDateTime();
        }

        function handleWaterCharacteristicChange(event) {
            const newValue = new TextDecoder().decode(event.target.value);
            waterValueContainer.innerHTML = newValue;
            waterTimestampContainer.innerHTML = getDateTime();
        }

        function writeOnCharacteristic(value) {
            if (bleServer && bleServer.connected) {
                bleServiceFound.getCharacteristic(ledCharacteristic)
                    .then(characteristic => {
                        const data = new Uint8Array([value]);
                        return characteristic.writeValue(data);
                    })
                    .then(() => {
                        latestValueSent.innerHTML = value;
                    })
                    .catch(error => {
                        console.error("Error writing to LED characteristic:", error);
                    });
            }
        }

        function disconnectDevice() {
            if (bleServer && bleServer.connected) {
                bleServer.disconnect();
                bleStateContainer.innerHTML = "Device Disconnected";
                bleStateContainer.style.color = "rgb(209,58,48)";
            }
        }

        function getDateTime() {
            return new Date().toLocaleString();
        }

        // Crop Info Dataset
        const crops = {
            "Rice": { temp: "25-30°C", moisture: "40-60% V/V%" },
            "Maize": { temp: "20-22°C", moisture: "14-21 V/V%" },
            "Wheat": { temp: "16-25°C", moisture: "30-36 V/V%" },
            "Mustard": { temp: "10-18°C", moisture: "18-22 V/V%" },
            "Large Cardamom": { temp: "15-30°C", moisture: "30-40 V/V%" }
        };

        const cropSelect = document.getElementById("cropSelect");
        const cropInfo = document.getElementById("cropInfo");

        cropSelect.addEventListener("change", () => {
            const crop = cropSelect.value;
            if (crop && crops[crop]) {
                cropInfo.innerHTML = `<strong>${crop}</strong><br>
                Optimal Temp: ${crops[crop].temp}<br>
                Soil Moisture: ${crops[crop].moisture}`;
            } else {
                cropInfo.innerHTML = "";
            }
        });
    </script>
</body>


</html>
